import pandas as pd
import re, jieba.analyse
import numpy as np
import joblib
from sklearn.feature_extraction.text import TfidfVectorizer


def nlpPre(x1):
    jieba.analyse.set_stop_words("controller/modeltrain/userdict.txt")

    voc = np.load('controller/modeltrain/vocabulary.npy').tolist()
    vectorizer = TfidfVectorizer(vocabulary=voc)
    x1 = vectorizer.fit_transform(x1.values.astype('U')).toarray()
    x1 = pd.DataFrame(x1)
    return x1


def dataprepare(s1):
    s = ""
    binary = pd.read_excel('controller/modeltrain/Binary.xlsx')
    st = [s1]
    data = pd.DataFrame({"examples": st})
    data['NetWork'] = 0
    data['BINSH'] = 0
    data['PATH'] = 0
    data['COMMAND_PYTHON'] = 0
    data['KEYWORD_-c'] = 0
    data['KEYWORD_-e'] = 0
    data['KEYWORD_SOCKET'] = 0
    data['PTY'] = 0
    data['python_socket'] = 0
    data['import_os'] = 0
    data['COMMAND_JAVA'] = 0
    data['COMMAND_INSTALL'] = 0
    for i in list(binary['Binary']):
        data['Binary_%s' % i] = 0
    # 匹配IP地址
    for i in range(len(data)):
        if re.search('(\d+).(\d+).(\d+).(\d+)', data.iloc[i, 0]) != None:
            data.iloc[i, 1] = 1

    # 匹配网址
    for i in range(len(data)):
        if 'http://' in data.iloc[i, 0] or '.com' in data.iloc[i, 0]:
            data.iloc[i, 1] = 1

    # 匹配shell
    for i in range(len(data)):
        if '/bin/sh' in data.iloc[i, 0]:
            data.iloc[i, 2] = 1

    # 匹配路径
    for i in range(len(data)):
        if '/bin/sh' in data.iloc[i, 0]:
            s = data.iloc[i, 0].replace('/bin/sh', '')
            if re.search('/(.*)/', data.iloc[i, 0]) != None:
                data.iloc[i, 3] = 1
        else:
            if re.search('/(.*)/', data.iloc[i, 0]) != None:
                data.iloc[i, 3] = 1

    # python
    for i in range(len(data)):
        if 'python' in data.iloc[i, 0]:
            data.iloc[i, 4] = 1

    # -c
    for i in range(len(data)):
        if ' -c ' in data.iloc[i, 0] or "'-c'" in data.iloc[i, 0]:
            data.iloc[i, 5] = 1

    # -e
    for i in range(len(data)):
        if ' -c ' in data.iloc[i, 0] or "'-e'" in data.iloc[i, 0]:
            data.iloc[i, 6] = 1

    # socket command
    for i in range(len(data)):
        if 'socket ' in data.iloc[i, 0]:
            data.iloc[i, 7] = 1

    # pty
    for i in range(len(data)):
        if 'pty' in data.iloc[i, 0]:
            data.iloc[i, 8] = 1

    # socket python
    for i in range(len(data)):
        if 'import' in data.iloc[i, 0] and 'socket' in data.iloc[i, 0]:
            data.iloc[i, 9] = 1

    # os python
    for i in range(len(data)):
        if 'import' in data.iloc[i, 0] and 'os' in data.iloc[i, 0]:
            data.iloc[i, 10] = 1

    # java
    for i in range(len(data)):
        if 'java' in data.iloc[i, 0]:
            data.iloc[i, 11] = 1

    # install
    for i in range(len(data)):
        if 'install' in data.iloc[i, 0]:
            data.iloc[i, 12] = 1

    # binary
    for i in range(len(data)):
        for j in list(binary['Binary']):
            if j == "file":
                if " file " in data.iloc[i,0] or 'file ' in data.iloc[i,0] or "\nfile " in data.iloc[i,0] or "./file" in data.iloc[i,0]:
                    data['Binary_%s' % j].iloc[i] = 1
                else:
                    data['Binary_%s' % j].iloc[i] = 0
            elif j == "su":
                if "su " in data.iloc[i,0]:
                    data['Binary_%s' % j].iloc[i] = 1
                else:
                    data['Binary_%s' % j].iloc[i] = 0
            elif j == "tar":
                if "tar" in data.iloc[i,0] and "-ttar" not in data.iloc[i,0]:
                    data['Binary_%s' % j].iloc[i] = 1
                else:
                    data['Binary_%s' % j].iloc[i] = 0
            elif j == "ar":
                if "ar " in data.iloc[i,0] and "tar" not in data.iloc[i,0]:
                    data['Binary_%s' % j].iloc[i] = 1
                else:
                    data['Binary_%s' % j].iloc[i] = 0
            else:
                s = j + " "
                if s in data.iloc[i,0]:
                    data['Binary_%s' % j].iloc[i] = 1

    # file_name
    data['file_name'] = 0
    for i in range(len(data)):
        if 'file' in data.iloc[i,0] or '.tar' in data.iloc[i,0] or '.txt' in data.iloc[i,0] or '.zip' in data.iloc[i,0]:
            data['file_name'][i] = 1

    # COMMAND_KEYWORD
    data['COMMAND_KEYWORD'] = 0
    for i in range(len(data)):
        if 'apt-get' not in data.iloc[i,0] and '-' in data.iloc[i,0]:
            data['COMMAND_KEYWORD'][i] = 1
    x1 = nlpPre(data['examples'])
    data = data.drop('examples', axis=1)
    data = pd.concat([data, x1], axis=1)

    return np.array(data)
