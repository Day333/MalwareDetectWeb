from flask import Blueprint, render_template, g, redirect, url_for, request, send_file, abort

from configs import UPLOAD_FOLDER
from controller.LotlModel import getRes
from controller.forms import CommandForm
from controller.UrlModel import getUrlRes
from controller.SqlModel import getSqlRes
from controller.LotlFile import getLotlFileRes
from werkzeug.utils import secure_filename
import os, magic

index_page = Blueprint("index_page", __name__)
ALLOWED_EXTENSIONS = {'xlsx', 'csv'}


def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS


@index_page.route("/")
def index():
    if g.user:
        title1 = "总览"
        return render_template("/index.html", title1=title1)
    else:
        return redirect(url_for("member_page.login"))


@index_page.route("/LotL", methods=['GET', 'POST'])
def LotL():
    if g.user:
        title1 = "LotL"
        if request.method == 'GET':
            return render_template("/LotLLinux.html", title1=title1)
        else:
            form = CommandForm(request.form)
            if form.validate():
                commandline = form.commandline.data
                if commandline != "":
                    resList = getRes(commandline)
                    Range = [_ for _ in range(len(resList))]
                    print("-----------------------------------")
                    print(resList)
                    print("-----------------------------------")
                    return render_template("/LotLLinux.html", title1=title1, result=resList, Range=Range)
                else:
                    return render_template("/LotLLinux.html", title1=title1)
            else:
                print(form.errors)
                return render_template("/LotLLinux.html", title1=title1)
    else:
        return redirect(url_for("member_page.login"))


@index_page.route("/LotLFile", methods=['GET', 'POST'])
def LotLFile():
    UPLOAD_PATH = os.path.join(os.path.dirname(__file__), '../upload')
    if g.user:
        title1 = "LotL"
        if request.method == 'GET':
            return render_template("/LotlFile.html", title1=title1)
        else:
            file = request.files['file']
            if file and allowed_file(file.filename):
                # 检查文件类型
                mime = magic.Magic(mime=True)
                file_type = mime.from_buffer(file.read(1024))
                file.seek(0)
                print("---------------------------------------------")
                print(file_type)
                print("---------------------------------------------")
                # if file_type not in {'application/vnd.ms-excel', 'text/csv', 'application/zip', 'text/plain'}:
                #     return '不允许上传的文件类型！'
                if file_type not in {'application/vnd.ms-excel', 'application/zip'}:
                    return '不允许上传的文件类型！'
                # 处理上传的文件
                filename = secure_filename(file.filename)
                file.save(os.path.join(UPLOAD_PATH, filename))
                resList = getLotlFileRes(filename, file_type)
                os.remove(os.path.join(UPLOAD_PATH, filename))
                return render_template("/LotlFile.html", title1=title1, result=resList)
            else:
                return '文件类型不支持！'

    else:
        return redirect(url_for("member_page.login"))


@index_page.route("/LotLIn")
def LotLIn():
    if g.user:
        title1 = "LotL/介绍"
        return render_template("/LotL_introduction.html", title1=title1)
    else:
        return redirect(url_for("member_page.login"))


@index_page.route("/urls", methods=['GET', 'POST'])
def UrlD():
    if g.user:
        title1 = "URL"
        if request.method == 'GET':
            return render_template("/UrlDete.html", title1=title1)
        else:
            form = CommandForm(request.form)
            if form.validate():
                url_get = form.commandline.data
                if url_get != "":
                    resList = getUrlRes(url_get)
                    Range = [_ for _ in range(len(resList))]
                    return render_template("/UrlDete.html", title1=title1, result=resList, Range=Range)
                else:
                    return render_template("/UrlDete.html", title1=title1)
            else:
                print(form.errors)
                return render_template("/UrlDete.html", title1=title1)
    else:
        return redirect(url_for("member_page.login"))


@index_page.route("/sqls", methods=['GET', 'POST'])
def SqlD():
    if g.user:
        title1 = "SQL"
        if request.method == 'GET':
            return render_template("/SqlDete.html", title1=title1)
        else:
            form = CommandForm(request.form)
            if form.validate():
                sql_get = form.commandline.data
                if sql_get != "":
                    resList = getSqlRes(sql_get)
                    Range = [_ for _ in range(len(resList))]
                    return render_template("/SqlDete.html", title1=title1, result=resList, Range=Range)
                else:
                    return render_template("//SqlDete.html", title1=title1)
            else:
                print(form.errors)
                return render_template("//SqlDete.html", title1=title1)
    else:
        return redirect(url_for("member_page.login"))


@index_page.route('/downloads/<filename>')
def download_file(filename):
    try:
        return send_file(os.path.join(UPLOAD_FOLDER, filename), as_attachment=True)
    except FileNotFoundError:
        abort(404)


@index_page.route("/dataL")
def dataL():
    if g.user:
        title1 = "data/load"
        return render_template("/dataLoads.html", title1=title1)
    else:
        return redirect(url_for("member_page.login"))


@index_page.route("/ShengMing")
def ShengMing():
    if g.user:
        title1 = "声明"
        return render_template("/shengming.html", title1=title1)
    else:
        return redirect(url_for("member_page.login"))


@index_page.route("/more")
def more():
    if g.user:
        title1 = "更多"
        return render_template("/more.html", title1=title1)
    else:
        return redirect(url_for("member_page.login"))