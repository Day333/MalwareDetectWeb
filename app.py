from flask import Flask, session, g
from controller.index import index_page
from controller.member import member_page
import configs
from user import User
from exts import db, mail

# 初始化实例
app = Flask(__name__)
# 加载配置文件
app.config.from_object(configs)
# 增加session会话保护(任意字符串,用来对session进行加密)
app.secret_key = "qwehjsda2131"
# db绑定app
db.init_app(app)
mail.init_app(app)
# 注册蓝图
app.register_blueprint(index_page, url_prefix="/")
app.register_blueprint(member_page, url_prefix="/member")

'''
模板函数
'''

from libs import UrlManager

app.add_template_global(UrlManager.buildUrl, 'buildUrl')
app.add_template_global(UrlManager.buildStaticUrl, 'buildStaticUrl')


@app.before_request
def my_before_request():
    user_id = session.get("user_id")
    if user_id:
        user = User.query.get(user_id)
        setattr(g, "user", user)
    else:
        setattr(g, "user", None)


@app.context_processor
def my_context_processor():
    return {"user": g.user}


@app.errorhandler(404)
def error_404(e):
    return "404 not found"